{% include "header.html" %}
    
    <div class="row">
      <div class="col-12">
        <div class="card">
			{%if info == 'wrong'%}
			<div class="alert alert-danger" role="alert">
			  The problem name may already exist.
			</div>
			{%endif%}
          <div class="card-header">
			<h3 class="card-title">Contest A - List problem</h3>
			<div class="card-tools">
				<form action="/contests/{{contest_id}}/from_zip" class="form-horizontal" method="POST" enctype=multipart/form-data>
					<div class="form-group row">
						<div class="col-sm-9">
							<input type="file" name="file">
						</div>
						<div class="col-sm-3">
							<input type="submit" class="btn btn-primary" name="fileSubmit" value="Submit" style="float:right;">						
						</div>					
					</div>		
				</form>
			</div>
          </div>
		  <!-- /.card-header -->
		  
          <div class="card-body table-responsive p-0">
            <table class="table table-hover table-bordered">
                <tr>
					<th style="width: 4em;">#</th>
					<th>Name</th>
					<th>Status</th>
					{% if session['role'] == 0 or author == session['user_id'] %}
					<th style="text-align: center;">Actions</th>
					{% endif %}
				</tr>
				{%if data|length > 0%}
				{%for problem in data%}
				<tr>
					<td>{{loop.index}}</td>
					<td><a href="/problems/{{problem['problem_id']}}/sources">{{problem['problem_name']}}</a></td>
					<td class="project-state">
						<span class="badge badge-success">{{problem['problem_status']}}</span>
					</td>
					{% if session['role'] == 0 or author == session['user_id'] %}
					<td class="text-center py-0 align-middle">
						<a class="btn btn-danger btn-delete" problem_id="{{problem['problem_id']}}"><i class="fas fa-trash"></i></a>
					</td>
					{% endif %}
				</tr>
				{%endfor%}
				{%endif%}
				<tr>
					<td>#</td>
					<td id="problem-name" colspan="3"><a href="#" id="create-problem" onclick="createProblem()"><b>Add new problem</b></a></td>
				</tr>
            </table>
		  </div>
          <!-- /.card-body -->
        </div>
      </div>
    </div>
   
	<div class="row">
		<div class="col-sm-12">
			<div class="card card-info">
				<div class="card-header">
					<h3 class="card-title">Run contest</h3>
				</div>
				<!-- /.card-header -->
				<form class="form-horizontal" method="POST" id="contest-run">
					<div class="card-body">
						<div class="row">
							<div class="col-sm-5">
								<div class="form-group row">
									<div class="custom-control custom-checkbox col-sm-6">
										<input class="custom-control-input" type="checkbox" id="countCheckBox">
										<label for="countCheckBox" class="custom-control-label"><b>CountOperator: </b></label>        
									</div>
									<div class="col-sm-6">
										<input type="number" class="form-control" id="countOperator" name="count_operator" min="0" max="100" value="50" disabled>        
									</div>
								</div>
							</div>
							<div class="col-sm-2"></div>
							<div class="col-sm-5">
								<div class="form-group row">
									<div class="custom-control custom-checkbox col-sm-6">
										<input class="custom-control-input" type="checkbox" id="setCheckBox">
										<label for="setCheckBox" class="custom-control-label"><b>SetOperator: </b></label>  
									</div>
									<div class="col-sm-6">
										<input type="number" class="form-control" id="setOperator" name="set_operator" min="0" max="100" value="50" disabled> 
									</div>
								</div>
							</div>		
						</div>

						<div class="row">
							<div class="col-sm-5">
								<div class="form-group row">
									<div class="custom-control custom-checkbox col-sm-6">
										<input class="custom-control-input" type="checkbox" id="hashCheckBox">
										<label for="hashCheckBox" class="custom-control-label"><b>HashOperator: </b></label>									</div>
									<div class="col-sm-6">
										<input type="number" class="form-control" id="hashOperator" name="hash_operator" min="0" max="100" value="50" disabled>	
									</div>
								</div>
							</div>
							<div class="col-sm-2"></div>
							<div class="col-sm-5">
								<div class="form-group row">
									<div class="custom-control custom-checkbox col-sm-6">
										<input class="custom-control-input" type="checkbox" id="smossCheckBox">
										<label for="smossCheckBox" class="custom-control-label"><b>SMOSS Metric: </b></label>        
									</div>
									<div class="col-sm-6">
										<input type="number" class="form-control" id="smossMetric" name="moss_score" min="0" max="100" value="50" disabled>
									</div>
								</div>
							</div>		
						</div>
					</div>
					<div class="card-footer">	
						<button type="submit" class="btn btn-primary" id="run">
							Run
						</button>
					</div>
				</form>
			</div>	
		</div>
	</div>

    <script type="text/javascript">
        document.getElementById('countCheckBox').onchange = function() {
            document.getElementById('countOperator').disabled = !this.checked;
        };

        document.getElementById('setCheckBox').onchange = function() {
            document.getElementById('setOperator').disabled = !this.checked;
        };

        document.getElementById('hashCheckBox').onchange = function() {
            document.getElementById('hashOperator').disabled = !this.checked;
        };

        document.getElementById('smossCheckBox').onchange = function() {
			document.getElementById('smossMetric').disabled = !this.checked;
		};

		function createProblem() {
			const form = document.createElement('form')
			const input = document.createElement('input')
			const submit = document.createElement('input')
			const row = document.createElement('div')
			const col10 = document.createElement('div')
			const col2 = document.createElement('div')

			form.method = "POST"
			form.action = "/contests/" + "{{contest_id}}" + "/problems"
			form.className = "form-horizontal"

			row.className = "form-group row"
			col10.className = "col-sm-10"
			col2.className = "col-sm-2"

			input.className = "form-control"
			input.name = "problem_name"

			submit.type = 'submit'
			submit.className = 'btn btn-primary'
			submit.name = 'submit'
			submit.value = 'Submit'
			submit.id = "create-pname-btn"

			col10.appendChild(input)
			col2.appendChild(submit)

			row.appendChild(col10)
			row.appendChild(col2)

			form.appendChild(row)

			link = document.getElementById('create-problem').remove()
			
			document.getElementById('problem-name').appendChild(form)
		}
    </script>
<!-- jQuery -->
<script src="{{ url_for('static', filename = 'jquery.min.js') }}"></script>
<!-- Bootstrap 4 -->
<script src="{{ url_for('static', filename = 'bootstrap.bundle.min.js') }}"></script>
<!-- SweetAlert -->
<script src="{{ url_for('static', filename = 'sweetalert2.all.js') }}"></script>
<!-- AdminLTE App -->
<script src="{{ url_for('static', filename = 'adminlte.min.js') }}"></script>

<script>
  $(document).ready(function() {
	$.ajaxSetup({
	  headers: {
		'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
	  }
	});

	const Toast = Swal.mixin({
		toast: true,
		position: 'top-end',
		showConfirmButton: false,
		timer: 5000
	})

	$("#contest-run").submit(function(e){
		e.preventDefault(); // avoid to execute the actual submit of the form.

		var form = $(this);
		var list_operator = form.serializeArray()
		console.log(list_operator)
		if (list_operator.length > 0) {
			var send_data = []
			list_operator.forEach(element => {
				var temp = {
					'name': element['name'],
					'threshold': element['value']/100
				}
				send_data.push(temp)
			});
			var data_form = {'metrics': send_data}
			$.ajax({
				type: "POST",
				url: "/api/contests/{{contest_id}}/run",
				contentType: 'application/json',
				data: JSON.stringify(data_form),
				success: function()
				{   
					$("#run").disabled
					$("#run").append("<span>", {"class": "pinner-border spinner-border-sm"})
					$("#run").text("Running...")
					var timer = setInterval(function() {
						$.get("/api/contests/{{contest_id}}/status", function(data) { 
							var contest_status = data['contest_status']
							if (contest_status == "checked") {
								$.get("/api/contests/{{contest_id}}/results", function(data, status){
									var result = JSON.stringify(data)
									if (data['results'].length > 0) {
										result = $("<button>", {"class": "btn btn-default"})
										a = $("<a>", {"href":"/contests/{{contest_id}}/results", "target": "_blank"})
										a.text("Result")
										result.append(a)
										$(".card-footer").append(result)
										$("#run").empty()
										$("#run").text("Run")
										$("#run").removeAttr("disabled")
									} else {
										Toast.fire({
											icon: 'error',
											title: 'No result in database'
										})
									}
								});
								clearInterval(timer);
							}
						})  
					}, 10000);
					
				},
				error: function(data)
				{
					alert(data['error'])
				}
			});
		} else {
			Toast.fire({
				icon: 'warning',
				title: 'Please select metrics first!'
			})
		}
	})

	$(document).on("click",".btn-delete",function(){
	  problem_id = $(this).attr('problem_id');
	  Swal.fire({
		title: 'Are you sure?',
		text: "You won't be able to revert this!",
		icon: 'warning',
		showCancelButton: true,
		confirmButtonColor: '#3085d6',
		cancelButtonColor: '#d33',
		confirmButtonText: 'Delete'
		}).then((result) => {
			if (result.isConfirmed) {
				$.ajax({
					type: "DELETE",
					contentType: 'application/json',
					url: "/api/problems/" + problem_id,
					success: function (data) {
						Toast.fire({
							icon: 'success',
							title: data['info']
						})
						setTimeout(function(){
							location.reload(true);
						}, 3000);
					},
					error: function (data) {
						Toast.fire({
							icon: 'error',
							title: data['error']
						})
					}
				});
			}
		})
	});
  })
</script>

</body></html>
